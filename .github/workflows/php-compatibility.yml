name: PHP Compatibility Tests

on:
  pull_request:
    branches: [ master, main ]
  push:
    branches: [ master, main ]

jobs:
  php-compatibility:
    name: PHP ${{ matrix.php }} / WP ${{ matrix.wordpress }}
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        php: ['8.1', '8.2', '8.3']
        wordpress: ['6.5', '6.6', '6.7']

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: ${{ matrix.php }}
          extensions: mysqli, curl, json, mbstring
          coverage: none

      - name: Syntax Check
        run: |
          echo "Running PHP syntax check..."
          find . -name "*.php" -not -path "./vendor/*" -not -path "./node_modules/*" -exec php -l {} \; | tee syntax-check.log
          if grep -q "Parse error" syntax-check.log; then
            echo "::error::PHP syntax errors found"
            exit 1
          fi
          echo "✓ No syntax errors found"

      - name: Test Plugin Constants
        run: |
          php -r "
            define('ABSPATH', '/tmp/');
            \$_SERVER['HTTP_HOST'] = 'localhost';
            \$_SERVER['REQUEST_URI'] = '/';
            require 'envato-market.php';
            if (!defined('ENVATO_MARKET_VERSION')) {
              echo '::error::Plugin failed to load - ENVATO_MARKET_VERSION not defined';
              exit(1);
            }
            echo '✓ Plugin loaded successfully on PHP ' . PHP_VERSION . PHP_EOL;
            echo '✓ Plugin version: ' . ENVATO_MARKET_VERSION . PHP_EOL;
          "

      - name: Check for Deprecations
        run: |
          php -d error_reporting=E_ALL -d display_errors=On -r "
            define('ABSPATH', '/tmp/');
            \$_SERVER['HTTP_HOST'] = 'localhost';
            \$_SERVER['REQUEST_URI'] = '/';
            error_reporting(E_ALL);
            ini_set('display_errors', 1);
            require 'envato-market.php';
          " 2>&1 | tee deprecations.log

          if grep -iE "deprecated|warning|notice" deprecations.log | grep -v "Undefined"; then
            echo "::warning::Deprecation warnings or notices found"
            cat deprecations.log
          else
            echo "✓ No deprecation warnings found"
          fi

      - name: Test Auto-Update Filter
        run: |
          php -r "
            define('ABSPATH', '/tmp/');
            \$_SERVER['HTTP_HOST'] = 'localhost';
            \$_SERVER['REQUEST_URI'] = '/';
            require 'envato-market.php';

            // Test that auto_update_plugin filter exists
            if (!has_filter('auto_update_plugin')) {
              echo '::error::auto_update_plugin filter not registered';
              exit(1);
            }
            echo '✓ Auto-update protection filter registered' . PHP_EOL;

            // Simulate update check on PHP <8.1 (should return false)
            \$test_item = (object) ['slug' => 'envato-market', 'new_version' => '3.0.0'];
            \$result = apply_filters('auto_update_plugin', true, \$test_item);

            if (version_compare(PHP_VERSION, '8.1', '>=')) {
              if (\$result === true) {
                echo '✓ Auto-update allowed on PHP ' . PHP_VERSION . PHP_EOL;
              } else {
                echo '::error::Auto-update should be allowed on PHP 8.1+';
                exit(1);
              }
            }
          "

  summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: php-compatibility
    if: always()
    steps:
      - name: Check results
        run: |
          if [ "${{ needs.php-compatibility.result }}" == "success" ]; then
            echo "✓ All PHP compatibility tests passed"
          else
            echo "::error::Some PHP compatibility tests failed"
            exit 1
          fi
